// =============================
//  MOTIVATION TRACKER PREMIUM
// =============================

const STORAGE_KEY = "motivationTracker_premium_v7_fix";

function loadDB() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
        return {
            meta: {
                targetWeight: null,
                startWeight: null,
                bestWeight: null,
                lastMilestoneWeight: null,
                lastImpedanceDate: null,
                notifCountByDay: {},
                lastDailyReminderDate: null
            },
            days: {}
        };
    }
    try {
        const parsed = JSON.parse(raw);
        if (!parsed.meta) parsed.meta = {};
        if (parsed.meta.targetWeight === undefined) parsed.meta.targetWeight = null;
        if (parsed.meta.startWeight === undefined) parsed.meta.startWeight = null;
        if (parsed.meta.bestWeight === undefined) parsed.meta.bestWeight = null;
        if (parsed.meta.lastMilestoneWeight === undefined) parsed.meta.lastMilestoneWeight = null;
        if (parsed.meta.lastImpedanceDate === undefined) parsed.meta.lastImpedanceDate = null;
        if (!parsed.meta.notifCountByDay) parsed.meta.notifCountByDay = {};
        if (parsed.meta.lastDailyReminderDate === undefined) parsed.meta.lastDailyReminderDate = null;
        if (!parsed.days) parsed.days = {};
        return parsed;
    } catch (e) {
        console.error("Errore nel parse del DB, resetto:", e);
        return {
            meta: {
                targetWeight: null,
                startWeight: null,
                bestWeight: null,
                lastMilestoneWeight: null,
                lastImpedanceDate: null,
                notifCountByDay: {},
                lastDailyReminderDate: null
            },
            days: {}
        };
    }
}

function saveDB() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
    } catch (e) {
        console.error("Errore salvataggio DB:", e);
    }
}

let DB = loadDB();

// ---- Date helpers ----

let currentDate = new Date();
currentDate.setHours(12, 0, 0, 0);

function dayIdFromDate(date) {
    return date.toISOString().split("T")[0];
}

function ensureDay(dayId) {
    if (!DB.days[dayId]) {
        DB.days[dayId] = {
            cardio: false,
            workout: "Rest",
            diet: false,
            workoutReason: "",
            dietReason: "",
            dietJustify: "",
            notes: "",
            weight: null,
            impedance: ""
        };
    }
    return DB.days[dayId];
}

// ---- UI elements ----

var todayLabelEl = document.getElementById("today-label");
var dayCardEl = document.getElementById("day-card");

var cardioSummaryEl = document.getElementById("cardio-summary");
var gymSummaryEl = document.getElementById("gym-summary");
var dietSummaryEl = document.getElementById("diet-summary");
var weightSummaryEl = document.getElementById("weight-summary");
var cardioBarEl = document.getElementById("cardio-bar");
var gymBarEl = document.getElementById("gym-bar");
var dietBarEl = document.getElementById("diet-bar");
var weightBarEl = document.getElementById("weight-bar");

var workoutReasonsListEl = document.getElementById("workout-reasons-list");
var dietReasonsListEl = document.getElementById("diet-reasons-list");
var impedanceReminderEl = document.getElementById("impedance-reminder");
var motivationBannerEl = document.getElementById("motivation-banner");
var badgeEl = document.getElementById("badge");
var statsModeEl = document.getElementById("stats-mode");
var targetWeightEl = document.getElementById("target-weight");

var prevDayBtn = document.getElementById("prev-day");
var nextDayBtn = document.getElementById("next-day");

// ---- Sounds (stile Apple Fitness, via WebAudio) ----

var audioCtx = null;

function ensureAudioContext() {
    if (!audioCtx) {
        var AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = new AC();
    }
}

function playVictorySound() {
    try {
        ensureAudioContext();
        if (!audioCtx) return;
        var now = audioCtx.currentTime;

        var osc1 = audioCtx.createOscillator();
        var gain1 = audioCtx.createGain();
        osc1.type = "sine";
        osc1.frequency.setValueAtTime(880, now);
        gain1.gain.setValueAtTime(0.18, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc1.connect(gain1).connect(audioCtx.destination);
        osc1.start(now);
        osc1.stop(now + 0.21);

        var osc2 = audioCtx.createOscillator();
        var gain2 = audioCtx.createGain();
        osc2.type = "triangle";
        osc2.frequency.setValueAtTime(1320, now + 0.2);
        gain2.gain.setValueAtTime(0.16, now + 0.2);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.45);
        osc2.connect(gain2).connect(audioCtx.destination);
        osc2.start(now + 0.2);
        osc2.stop(now + 0.46);
    } catch (e) {
        console.warn("Audio non disponibile:", e);
    }
}

function playMilestoneSound() {
    try {
        ensureAudioContext();
        if (!audioCtx) return;
        var now = audioCtx.currentTime;
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.type = "square";
        osc.frequency.setValueAtTime(1320, now);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.35);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.36);
    } catch (e) {
        console.warn("Audio non disponibile:", e);
    }
}

// ---- Frasi motivazionali ----

var successPhrases = [
    "Perfetto, continua cos√¨ e spacca tutto!",
    "Ogni spunta √® un passo in meno verso il vecchio te.",
    "Stai costruendo costanza vera, non √® da tutti.",
    "Questo √® il lavoro che far√† la differenza.",
    "Gigio, cos√¨ si fa: oggi hai alzato l‚Äôasticella."
];

var failurePhrases = [
    "Oggi pu√≤ essere andata cos√¨, ma domani hai un‚Äôaltra occasione.",
    "Non cambiano 24 ore, cambia cosa fai nelle prossime 24.",
    "Usa questa giornata come benzina, non come scusa.",
    "Scivolare capita, mollare no. Torna pi√π forte domani.",
    "Il fatto che ci tieni lo dimostra il fatto che lo stai registrando."
];

var weightPhrases = [
    "Un chilo in meno, una versione pi√π leggera e pi√π forte di te.",
    "Risultato di tutte le micro-scelte giuste. Continua.",
    "Sei ufficialmente sulla strada giusta, non fermarti ora.",
    "Ogni kg perso √® un voto di fiducia che ti sei dato.",
    "Numeri gi√π sulla bilancia, mentalit√† sempre pi√π su."
];

// ---- Badge & banner ----

function showBadge(message) {
    if (!badgeEl) return;
    badgeEl.textContent = message;
    badgeEl.classList.remove("hidden");
    badgeEl.classList.add("show");
    setTimeout(function () {
        badgeEl.classList.remove("show");
    }, 1700);
}

function showMotivation(message) {
    if (!motivationBannerEl) return;
    motivationBannerEl.textContent = message;
}

// ---- Notifiche ----

function getNotifCountFor(dayId) {
    var map = DB.meta.notifCountByDay || {};
    return map[dayId] || 0;
}
function incrementNotifCountFor(dayId) {
    if (!DB.meta.notifCountByDay) DB.meta.notifCountByDay = {};
    DB.meta.notifCountByDay[dayId] = getNotifCountFor(dayId) + 1;
}

function maybeSendFailureNotification(dayId) {
    if (typeof Notification === "undefined") return;
    if (Notification.permission !== "granted") return;
    if (getNotifCountFor(dayId) >= 3) return;

    var phrase = failurePhrases[Math.floor(Math.random() * failurePhrases.length)];
    try {
        new Notification("Non mollare adesso.", { body: phrase });
        incrementNotifCountFor(dayId);
        saveDB();
    } catch (e) {
        console.warn("Notifica non riuscita:", e);
    }
}

// reminder 22:00 per compilazione dati
function scheduleDailyReminder() {
    if (typeof Notification === "undefined") return;
    if (Notification.permission !== "granted") return;

    setInterval(function () {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var todayId = dayIdFromDate(now);

        if (hours === 22 && minutes === 0 && DB.meta.lastDailyReminderDate !== todayId) {
            try {
                new Notification("Compila il tuo Motivation Tracker", {
                    body: "Segna cardio, allenamento e dieta di oggi."
                });
                DB.meta.lastDailyReminderDate = todayId;
                saveDB();
            } catch (e) {
                console.warn("Notifica reminder non riuscita:", e);
            }
        }
    }, 60000);
}

// ---- Impedenza ----

function checkImpedanceReminder(todayId) {
    if (!impedanceReminderEl) return;
    var last = DB.meta.lastImpedanceDate;
    if (!last) {
        impedanceReminderEl.classList.remove("hidden");
        return;
    }
    var lastDate = new Date(last);
    var today = new Date(todayId);
    var diffMs = today - lastDate;
    var diffDays = diffMs / (1000 * 60 * 60 * 24);
    if (diffDays >= 7) {
        impedanceReminderEl.classList.remove("hidden");
    } else {
        impedanceReminderEl.classList.add("hidden");
    }
}

// ---- Ranges statistiche ----

function getRangeDates(mode, anchor) {
    var start = new Date(anchor.getTime());
    var end = new Date(anchor.getTime());
    if (mode === "week") {
        var day = anchor.getDay();
        var diffToMonday = (day === 0 ? -6 : 1) - day;
        start.setDate(anchor.getDate() + diffToMonday);
        start.setHours(12, 0, 0, 0);
        end.setTime(start.getTime());
        end.setDate(start.getDate() + 6);
    } else if (mode === "month") {
        start.setDate(1);
        start.setHours(12, 0, 0, 0);
        end.setMonth(start.getMonth() + 1);
        end.setDate(0);
    } else if (mode === "year") {
        start.setMonth(0, 1);
        start.setHours(12, 0, 0, 0);
        end.setMonth(11, 31);
    }
    return { start: start, end: end };
}

function getDatesBetween(start, end) {
    var dates = [];
    var d = new Date(start.getTime());
    while (d <= end) {
        dates.push(new Date(d.getTime()));
        d.setDate(d.getDate() + 1);
    }
    return dates;
}

// ---- Statistiche & motivi ----

function updateStats() {
    var mode = statsModeEl.value;
    var range = getRangeDates(mode, currentDate);
    var dates = getDatesBetween(range.start, range.end);

    var cardioCount = 0;
    var gymCount = 0;
    var dietCount = 0;
    var totalDays = dates.length;

    var lastWeight = null;

    var workoutReasonsCounter = {
        non_aria: 0,
        lavoro: 0,
        scarico: 0
    };
    var dietReasonsCounter = {
        sgarro: 0,
        non_aria: 0,
        pasto_fuori: 0
    };

    dates.forEach(function (d) {
        var id = dayIdFromDate(d);
        var entry = DB.days[id];
        if (!entry) return;

        if (entry.cardio) cardioCount++;
        if (entry.workout === "Leg" || entry.workout === "Pull" || entry.workout === "Push") gymCount++;
        if (entry.diet) dietCount++;

        if (entry.weight != null) {
            lastWeight = entry.weight;
        }

        if (entry.workoutReason && workoutReasonsCounter[entry.workoutReason] != null) {
            workoutReasonsCounter[entry.workoutReason]++;
        }
        if (entry.dietReason && dietReasonsCounter[entry.dietReason] != null) {
            dietReasonsCounter[entry.dietReason]++;
        }
    });

    var cardioPerc = totalDays ? Math.round((cardioCount / totalDays) * 100) : 0;
    var dietPerc = totalDays ? Math.round((dietCount / totalDays) * 100) : 0;
    var gymTarget = 3;
    var gymPerc = gymTarget ? Math.min(100, Math.round((gymCount / gymTarget) * 100)) : 0;

    if (cardioSummaryEl) cardioSummaryEl.textContent = cardioCount + "/" + totalDays + " (" + cardioPerc + "%)";
    if (gymSummaryEl) gymSummaryEl.textContent = gymCount + "/" + gymTarget + " (" + gymPerc + "%)";
    if (dietSummaryEl) dietSummaryEl.textContent = dietCount + "/" + totalDays + " (" + dietPerc + "%)";

    if (cardioBarEl) cardioBarEl.style.width = cardioPerc + "%";
    if (dietBarEl) dietBarEl.style.width = dietPerc + "%";
    if (gymBarEl) gymBarEl.style.width = gymPerc + "%";

    // peso
    var target = DB.meta.targetWeight;
    var startW = DB.meta.startWeight;
    var weightText = "‚Äì";
    var weightPerc = 0;

    if (target != null && startW != null && lastWeight != null && startW > target) {
        var totalLossNeeded = startW - target;
        var currentLoss = startW - lastWeight;
        if (totalLossNeeded > 0) {
            weightPerc = Math.max(0, Math.min(100, Math.round((currentLoss / totalLossNeeded) * 100)));
            weightText = currentLoss.toFixed(1) + "kg / " +
                totalLossNeeded.toFixed(1) + "kg (" + weightPerc + "%)";
        }
    } else if (lastWeight != null) {
        weightText = lastWeight.toFixed(1) + " kg";
        weightPerc = 0;
    }

    if (weightSummaryEl) weightSummaryEl.textContent = weightText;
    if (weightBarEl) weightBarEl.style.width = weightPerc + "%";

    // liste motivi
    if (workoutReasonsListEl) {
        workoutReasonsListEl.innerHTML = "";
        var labelsW = {
            non_aria: "Oggi non √® aria",
            lavoro: "Lavoro",
            scarico: "Sono scarico"
        };
        Object.keys(workoutReasonsCounter).forEach(function (key) {
            var li = document.createElement("li");
            li.innerHTML =
                '<span class="reason-label">' + labelsW[key] +
                '</span><span class="reason-count">' + workoutReasonsCounter[key] + "</span>";
            workoutReasonsListEl.appendChild(li);
        });
    }

    if (dietReasonsListEl) {
        dietReasonsListEl.innerHTML = "";
        var labelsD = {
            sgarro: "Giornata sgarro",
            non_aria: "Oggi non √® aria",
            pasto_fuori: "Pasto fuori"
        };
        Object.keys(dietReasonsCounter).forEach(function (key) {
            var li2 = document.createElement("li");
            li2.innerHTML =
                '<span class="reason-label">' + labelsD[key] +
                '</span><span class="reason-count">' + dietReasonsCounter[key] + "</span>";
            dietReasonsListEl.appendChild(li2);
        });
    }
}

// ---- Rendering giornata ----

function renderDay() {
    var dayId = dayIdFromDate(currentDate);
    var entry = ensureDay(dayId);

    var dayName = currentDate.toLocaleDateString("it-IT", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric"
    });

    if (todayLabelEl) {
        var nice = dayName.charAt(0).toUpperCase() + dayName.slice(1);
        todayLabelEl.textContent = nice;
    }

    dayCardEl.innerHTML =
        '<div class="day-card-header">' +
        ' <div class="day-title">Dettagli giornata</div>' +
        "</div>" +

        '<div class="checkbox-row">' +
        ' <input type="checkbox" id="cardio" ' + (entry.cardio ? "checked" : "") + ">" +
        ' <label for="cardio">Cardio completato (60 min walking pad)</label>' +
        "</div>" +

        '<div class="section-label">Allenamento</div>' +
        '<select id="workout">' +
        ' <option value="Leg" ' + (entry.workout === "Leg" ? "selected" : "") + ">Leg</option>" +
        ' <option value="Pull" ' + (entry.workout === "Pull" ? "selected" : "") + ">Pull</option>" +
        ' <option value="Push" ' + (entry.workout === "Push" ? "selected" : "") + ">Push</option>" +
        ' <option value="Rest" ' + (entry.workout === "Rest" ? "selected" : "") + ">Rest (riposo)</option>" +
        "</select>" +

        '<div class="section-label">Motivo se non ti sei allenato</div>' +
        '<select id="workout-reason">' +
        ' <option value="">Nessuno</option>' +
        ' <option value="non_aria" ' + (entry.workoutReason === "non_aria" ? "selected" : "") + ">Oggi non √® aria</option>" +
        ' <option value="lavoro" ' + (entry.workoutReason === "lavoro" ? "selected" : "") + ">Lavoro</option>" +
        ' <option value="scarico" ' + (entry.workoutReason === "scarico" ? "selected" : "") + ">Sono scarico</option>" +
        "</select>" +

        '<div class="section-label">Dieta</div>' +
        '<div class="checkbox-row">' +
        ' <input type="checkbox" id="diet" ' + (entry.diet ? "checked" : "") + ">" +
        ' <label for="diet">Aderenza al piano alimentare</label>' +
        "</div>" +

        '<div class="section-label">Motivo mancata aderenza dieta</div>' +
        '<select id="diet-reason">' +
        ' <option value="">Nessuno</option>' +
        ' <option value="sgarro" ' + (entry.dietReason === "sgarro" ? "selected" : "") + ">Giornata sgarro</option>" +
        ' <option value="non_aria" ' + (entry.dietReason === "non_aria" ? "selected" : "") + ">Oggi non √® aria</option>" +
        ' <option value="pasto_fuori" ' + (entry.dietReason === "pasto_fuori" ? "selected" : "") + ">Pasto fuori</option>" +
        "</select>" +

        '<div class="section-label">Giustificazione pasto (se sgarro / non √® aria)</div>' +
        '<select id="diet-justify">' +
        ' <option value="">Nessuna</option>' +
        ' <option value="delivery" ' + (entry.dietJustify === "delivery" ? "selected" : "") + ">Delivery</option>" +
        ' <option value="ristorante" ' + (entry.dietJustify === "ristorante" ? "selected" : "") + ">Ristorante</option>" +
        ' <option value="chef" ' + (entry.dietJustify === "chef" ? "selected" : "") + ">Chef üë®‚Äçüç≥</option>" +
        "</select>" +

        '<div class="section-label">Peso (kg) e Impedenziometria</div>' +
        '<div class="fields-inline">' +
        ' <div>' +
        '  <label for="weight" style="font-size:11px;">Peso</label>' +
        '  <input type="number" id="weight" step="0.1" value="' + (entry.weight != null ? entry.weight : "") + '" placeholder="Es. 82.5">' +
        " </div>" +
        ' <div>' +
        '  <label for="impedance" style="font-size:11px;">Impedenziometria</label>' +
        '  <input type="text" id="impedance" value="' + (entry.impedance || "") + '" placeholder="%BF, massa magra, ecc.">' +
        " </div>" +
        "</div>" +

        '<div class="section-label">Note</div>' +
        '<textarea id="notes" placeholder="Appunti su come √® andata la giornata, sensazioni, focus...">' +
        (entry.notes || "") + "</textarea>";

    // bind controlli
    var cardioEl = document.getElementById("cardio");
    var workoutEl = document.getElementById("workout");
    var workoutReasonEl = document.getElementById("workout-reason");
    var dietEl = document.getElementById("diet");
    var dietReasonEl = document.getElementById("diet-reason");
    var dietJustifyEl = document.getElementById("diet-justify");
    var weightEl = document.getElementById("weight");
    var impedanceEl = document.getElementById("impedance");
    var notesEl = document.getElementById("notes");

    var dayIdLocal = dayId;

    function saveAndUpdate(source) {
        var e = ensureDay(dayIdLocal);
        e.cardio = cardioEl.checked;
        e.workout = workoutEl.value;
        e.workoutReason = workoutReasonEl.value;
        e.diet = dietEl.checked;
        e.dietReason = dietReasonEl.value;
        e.dietJustify = dietJustifyEl.value;
        e.notes = notesEl.value;

        var weightVal = parseFloat(weightEl.value);
        e.weight = isNaN(weightVal) ? null : weightVal;
        e.impedance = impedanceEl.value;

        // gestione peso
        if (e.weight != null) {
            if (DB.meta.startWeight == null) {
                DB.meta.startWeight = e.weight;
                DB.meta.bestWeight = e.weight;
                DB.meta.lastMilestoneWeight = e.weight;
            } else {
                if (DB.meta.bestWeight == null || e.weight < DB.meta.bestWeight) {
                    DB.meta.bestWeight = e.weight;
                }
                if (DB.meta.lastMilestoneWeight != null) {
                    var diff = DB.meta.lastMilestoneWeight - e.weight;
                    if (diff >= 1) {
                        DB.meta.lastMilestoneWeight = e.weight;
                        playMilestoneSound();
                        var phraseW = weightPhrases[Math.floor(Math.random() * weightPhrases.length)];
                        showBadge("Nuovo traguardo peso! üéâ");
                        showMotivation(phraseW);
                    }
                } else {
                    DB.meta.lastMilestoneWeight = e.weight;
                }
            }
        }

        if (e.impedance && e.impedance.trim().length > 0) {
            DB.meta.lastImpedanceDate = dayIdLocal;
        }

        saveDB();
        updateStats();
        checkImpedanceReminder(dayIdLocal);

        // victory
        if (source === "cardio" && e.cardio) {
            playVictorySound();
            var phrase1 = successPhrases[Math.floor(Math.random() * successPhrases.length)];
            showBadge("Cardio completato ‚úÖ");
            showMotivation(phrase1);
        }
        if (source === "workout" && (e.workout === "Leg" || e.workout === "Pull" || e.workout === "Push")) {
            playVictorySound();
            var phrase2 = successPhrases[Math.floor(Math.random() * successPhrases.length)];
            showBadge("Allenamento registrato ‚úÖ");
            showMotivation(phrase2);
        }
        if (source === "diet" && e.diet) {
            playVictorySound();
            var phrase3 = successPhrases[Math.floor(Math.random() * successPhrases.length)];
            showBadge("Dieta rispettata ‚úÖ");
            showMotivation(phrase3);
        }

        // failure motivazionale
        if (source === "workoutReason" && e.workoutReason) {
            maybeSendFailureNotification(dayIdLocal);
            var phraseF1 = failurePhrases[Math.floor(Math.random() * failurePhrases.length)];
            showMotivation(phraseF1);
        }
        if (source === "dietReason" && e.dietReason) {
            maybeSendFailureNotification(dayIdLocal);
            var phraseF2 = failurePhrases[Math.floor(Math.random() * failurePhrases.length)];
            showMotivation(phraseF2);
        }
    }

    cardioEl.addEventListener("change", function () { saveAndUpdate("cardio"); });
    workoutEl.addEventListener("change", function () { saveAndUpdate("workout"); });
    workoutReasonEl.addEventListener("change", function () { saveAndUpdate("workoutReason"); });
    dietEl.addEventListener("change", function () { saveAndUpdate("diet"); });
    dietReasonEl.addEventListener("change", function () { saveAndUpdate("dietReason"); });
    dietJustifyEl.addEventListener("change", function () { saveAndUpdate("dietJustify"); });
    weightEl.addEventListener("change", function () { saveAndUpdate("weight"); });
    impedanceEl.addEventListener("change", function () { saveAndUpdate("impedance"); });
    notesEl.addEventListener("input", function () { saveAndUpdate("notes"); });
}

// ---- Target weight ----

function initTargetWeight() {
    if (DB.meta.targetWeight != null) {
        targetWeightEl.value = DB.meta.targetWeight;
    }
    targetWeightEl.addEventListener("change", function () {
        var v = parseFloat(targetWeightEl.value);
        DB.meta.targetWeight = isNaN(v) ? null : v;
        saveDB();
        updateStats();
    });
}

// ---- Navigation & stats mode ----

prevDayBtn.addEventListener("click", function () {
    currentDate.setDate(currentDate.getDate() - 1);
    renderAll();
});

nextDayBtn.addEventListener("click", function () {
    currentDate.setDate(currentDate.getDate() + 1);
    renderAll();
});

statsModeEl.addEventListener("change", function () {
    renderAll();
});

// ---- Render globale ----

function renderAll() {
    renderDay();
    updateStats();
    var todayId = dayIdFromDate(currentDate);
    checkImpedanceReminder(todayId);
}

// ---- Bootstrap ----

window.addEventListener("load", function () {
    if (typeof Notification !== "undefined" && Notification.permission === "default") {
        try {
            Notification.requestPermission();
        } catch (e) {
            console.warn("Permesso notifiche non richiesto:", e);
        }
    }
    initTargetWeight();
    renderAll();
    scheduleDailyReminder();
});